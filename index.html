<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€5å¤©4å¤œã€‘æ±äº¬ä¹‹æ—… - è¡Œç¨‹èˆ‡è²»ç”¨è¿½è¹¤</title>
    <style>
        /* --- Itinerary & General Styles (Inherited from your code) --- */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            max-width: 900px; /* Increased max-width for better tracker layout */
            margin-left: auto;
            margin-right: auto;
        }
        h1 {
            color: #d9534f;
            border-bottom: 3px solid #d9534f;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        h2 {
            color: #5bc0de;
            margin-top: 25px;
            border-left: 5px solid #5bc0de;
            padding-left: 10px;
        }
        .day {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .day strong {
            display: block;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 5px;
        }
        .note {
            background-color: #d9edf7;
            border: 1px solid #bce8f1;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
            color: #31708f;
        }
        .note p {
            margin: 5px 0;
        }

        /* --- Expense Tracker Styles --- */
        #expense-tracker {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
        #expense-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 100px; /* Item, Amount, Payer, Button */
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 4px;
        }
        #expense-form input, #expense-form select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        #expense-form button {
            background-color: #28a745; /* Green button */
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 4px;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        #expense-form button:hover {
            background-color: #218838;
        }
        
        /* Tables */
        .expense-table, .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            text-align: left;
        }
        .expense-table th, .expense-table td, 
        .report-table th, .report-table td {
            border: 1px solid #eee;
            padding: 12px;
        }
        .expense-table th, .report-table th {
            background-color: #f8f8f8;
            color: #333;
            font-weight: bold;
        }
        .expense-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Report Summary */
        .report-table .positive {
            color: #28a745; /* Green for "Owes" */
            font-weight: bold;
        }
        .report-table .negative {
            color: #d9534f; /* Red for "Is Owed" */
            font-weight: bold;
        }
        .report-table tr.total-row td {
            font-weight: bold;
            background-color: #e9ecef;
            border-top: 2px solid #5bc0de;
        }

        /* For mobile */
        @media (max-width: 600px) {
            #expense-form {
                grid-template-columns: 1fr; /* Stack inputs vertically on small screens */
            }
            #expense-form button {
                grid-column: 1; /* Make button full width */
            }
        }
    </style>
</head>
<body>

    <h1>âœˆï¸ ã€5å¤©4å¤œã€‘æ±äº¬ä¹‹æ—…è¡Œç¨‹</h1>

    <div class="day">
        <h2>Day 1: æŠµé”èˆ‡å±•æœ›</h2>
        <strong>æ©Ÿå ´ â†’ é£¯åº— Check-in â†’ æ™´ç©ºå¡”</strong>
        <ul>
            <li>ç”± ç¾½ç”°æ©Ÿå ´ï¼æˆç”°æ©Ÿå ´ æŠµé”æ±äº¬å¸‚å€</li>
            <li>é£¯åº— Check in</li>
            <li>**æ™´ç©ºå¡”**ï¼ˆè³¼ç‰©ã€æ™šé¤ã€è³å¤œæ™¯ï¼‰</li>
        </ul>
    </div>

    <div class="day">
        <h2>Day 2: å‚³çµ±èˆ‡æ½®æµ (éŠ€åº§ç·šé«˜æ•ˆéŠ)</h2>
        <strong>æ·ºè‰ â†’ ç§‹è‘‰åŸ â†’ éŠ€åº§</strong>
        <ul>
            <li>**æ·ºè‰**ï¼ˆé›·é–€ã€ä»²è¦‹ä¸–é€šå•†åº—è¡—ã€æ·ºè‰å¯ºï¼‰</li>
            <li>**ç§‹è‘‰åŸé›»å™¨è¡—**</li>
            <li>**éŠ€åº§**ï¼ˆé€›è¡—ã€ä¸‹åˆèŒ¶æˆ–ç”¨é¤ï¼‰</li>
        </ul>
    </div>

    <div class="day">
        <h2>Day 3: æ–°å®¿ä¸€æ—¥éŠ</h2>
        <strong>ä¼‘é–’ã€è³¼ç‰©èˆ‡å¨›æ¨‚</strong>
        <ul>
            <li>**æ–°å®¿å¾¡è‹‘**é‡é¤</li>
            <li>**ä¼Šå‹¢ä¸¹ç™¾è²¨**</li>
            <li>**æ–°å®¿æ±å£3Dè²“**</li>
            <li>**æ–°å®¿èŠ±åœ’ç¥ç¤¾**</li>
            <li>**æ±æ€¥æ­Œèˆä¼ç”ºTOWER**</li>
        </ul>
    </div>

    <div class="day">
        <h2>Day 4: å¸‚å ´ã€è—è¡“èˆ‡æ­·å²</h2>
        <strong>æµ·é®®ã€å…‰å½±èˆ‡çš‡å®¤</strong>
        <ul>
            <li>**è±æ´²å¸‚å ´**</li>
            <li>**teamLab Planets TOKYO**</li>
            <li>**æ±äº¬è»Šç«™**ï¼ˆç”¨é¤ã€è³¼ç‰©ï¼‰</li>
            <li>**çš‡å±…å¤–è‹‘æ•£ç­–**</li>
            <li>**æ±äº¬éµå¡”**</li>
        </ul>
    </div>

    <div class="day">
        <h2>Day 5: è³¦æ­¸</h2>
        <strong>æ©Ÿå ´è³¼ç‰©</strong>
        <ul>
            <li>ç”± ç¾½ç”°æ©Ÿå ´ï¼æˆç”°æ©Ÿå ´ å›ç¨‹ã€‚</li>
            <li>**æ¨è–¦ï¼š** ææ—©åˆ°æ©Ÿå ´è³¼ç‰©ç”¨é¤ã€‚</li>
        </ul>
    </div>

    <h2>è¡Œç¨‹é‡é»æé†’ (Memo)</h2>
    <div class="note">
        <p>ãƒ»5å¤©ç©æ±äº¬æœƒè¼ƒç‚ºç·Šæ¹Šï¼Œéƒ¨åˆ†æ™¯é»å¯æ¡é‡é»å¼éŠè¦½ã€‚ä¸éä¾ç„¶æé†’å¤§å®¶ï¼Œæ™¯é»ä¹‹é–“ä¾ç„¶è¦ä¿ç•™ä¼‘æ¯ç©ºæª”å”·ã€‚</p>
        <p>ãƒ»**äº¤é€šæé†’ï¼š** Day 2 å¯å–„ç”¨**æ±äº¬Metroã€ŒéŠ€åº§ç·šã€**ï¼šæ·ºè‰ â†’ æœ«å»£ç”º (ç§‹è‘‰åŸå•†åœˆ) â†’ éŠ€åº§ã€‚</p>
        <p>ãƒ»**å®¶åº­å‹å–„ï¼š** Day 3 è¦åŠƒäº†ã€Œæ–°å®¿ä¸€æ—¥éŠã€ï¼Œå¾ˆé©åˆä¸€å®¶å¤§å°ç©ä¸Šä¸€æ•´å¤©ï¼</p>
        <p>ãƒ»**åŸå§‹åƒè€ƒç¶²å€ï¼š** <a href="https://tokyo.letsgojp.com/archives/301458/" target="_blank">æ¨‚åƒè³¼ï¼æ—¥æœ¬ (é»æ“Šé–‹å•Ÿ)</a></p>
    </div>

    <div id="expense-tracker">
        <h2>ğŸ’° å…±åŒè²»ç”¨è¿½è¹¤</h2>

        <div>
            <label for="participants-input">**è¨­å®šåƒèˆ‡è€… (ä»¥é€—è™Ÿæˆ–åˆ†è™Ÿåˆ†éš”, å¦‚: A, B, C):**</label>
            <input type="text" id="participants-input" placeholder="å°æ˜, å°è¯, å°ç¾" style="width: 100%; margin: 5px 0 15px 0; padding: 10px;">
            <button onclick="updateParticipants()">âœ… ç¢ºèªåƒèˆ‡è€…</button>
            <p id="participant-status" style="margin-top: 10px; font-weight: bold; color: #5cb85c;">è«‹å…ˆè¨­å®šåƒèˆ‡è€…</p>
        </div>
        <hr style="margin: 20px 0;">

        <h3>æ–°å¢è²»ç”¨é …ç›®</h3>
        <div id="expense-form">
            <input type="text" id="expense-item" placeholder="è²»ç”¨é …ç›® (e.g. æ™´ç©ºå¡”é–€ç¥¨)" required>
            <input type="number" id="expense-amount" placeholder="é‡‘é¡ (JPY)" min="1" required>
            <select id="expense-payer">
                </select>
            <button onclick="addExpense()">æ–°å¢</button>
        </div>

        <h3>æ‰€æœ‰è²»ç”¨åˆ—è¡¨</h3>
        <table class="expense-table">
            <thead>
                <tr>
                    <th>é …ç›®</th>
                    <th>é‡‘é¡ (JPY)</th>
                    <th>æ”¯ä»˜äºº</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="expense-list">
                </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="1">ç¸½å…±åŒèŠ±è²»</td>
                    <td id="total-expense" colspan="3">0 JPY</td>
                </tr>
            </tfoot>
        </table>

        <h2 style="margin-top: 30px;">ğŸ“Š è²»ç”¨çµç®—å ±å‘Š</h2>
        <p><strong>äººå‡æ‡‰ä»˜é‡‘é¡ (Per Person Share):</strong> <span id="per-person-share">0 JPY</span></p>
        <table class="report-table">
            <thead>
                <tr>
                    <th>åƒèˆ‡è€…</th>
                    <th>ç¸½æ”¯å‡º</th>
                    <th>æ‡‰ä»˜ä»½é¡</th>
                    <th>é¤˜é¡ (Owes / Is Owed)</th>
                </tr>
            </thead>
            <tbody id="report-summary">
                </tbody>
        </table>

        <h3 style="margin-top: 30px;">ğŸ’¸ çµç®—å»ºè­° (Who Owes Whom)</h3>
        <ul id="settlement-advice" style="list-style-type: none; padding-left: 0;">
             <li><em>è«‹å…ˆæ–°å¢è²»ç”¨é …ç›®...</em></li>
        </ul>
    </div>

    <div class="scroll-spacer" style="height: 100px;"></div>

    <script>
        let expenses = [];
        let participants = [];

        // --- Participant Management ---
        function updateParticipants() {
            const input = document.getElementById('participants-input').value.trim();
            if (input) {
                // Split by comma or semicolon, trim whitespace, and filter out empty strings
                participants = input.split(/[,;]/).map(p => p.trim()).filter(p => p.length > 0);
                
                // Update dropdown and status
                updatePayerDropdown();
                document.getElementById('participant-status').textContent = `âœ… åƒèˆ‡è€…å·²è¨­å®š: ${participants.join(', ')}`;
                document.getElementById('participant-status').style.color = '#5cb85c';
            } else {
                participants = [];
                document.getElementById('participant-status').textContent = `âŒ è«‹è¼¸å…¥åƒèˆ‡è€…åç¨±`;
                document.getElementById('participant-status').style.color = '#d9534f';
            }
            // Recalculate everything after updating participants
            renderExpenses();
            generateReport();
        }

        function updatePayerDropdown() {
            const dropdown = document.getElementById('expense-payer');
            dropdown.innerHTML = ''; // Clear existing options
            if (participants.length === 0) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'è«‹å…ˆè¨­å®šåƒèˆ‡è€…';
                dropdown.appendChild(defaultOption);
                dropdown.disabled = true;
                return;
            }
            dropdown.disabled = false;
            participants.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                dropdown.appendChild(option);
            });
        }

        // --- Expense Management ---
        function addExpense() {
            const item = document.getElementById('expense-item').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const payer = document.getElementById('expense-payer').value;

            if (!item || isNaN(amount) || amount <= 0 || !payer) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦ç¢ºä¿é‡‘é¡æœ‰æ•ˆï¼');
                return;
            }
            
            if (participants.length === 0) {
                 alert('è«‹å…ˆè¨­å®šåƒèˆ‡è€…ï¼');
                 return;
            }

            expenses.push({ item, amount, payer });

            // Clear form
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';

            renderExpenses();
            generateReport();
        }

        function deleteExpense(index) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤é …ç›® "${expenses[index].item}" å—ï¼Ÿ`)) {
                expenses.splice(index, 1);
                renderExpenses();
                generateReport();
            }
        }

        function renderExpenses() {
            const listBody = document.getElementById('expense-list');
            listBody.innerHTML = '';
            let total = 0;

            expenses.forEach((exp, index) => {
                total += exp.amount;
                const row = listBody.insertRow();
                row.insertCell().textContent = exp.item;
                row.insertCell().textContent = exp.amount.toLocaleString('ja-JP'); // Format as JPY
                row.insertCell().textContent = exp.payer;
                
                const deleteCell = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'åˆªé™¤';
                deleteButton.onclick = () => deleteExpense(index);
                deleteButton.style.cssText = 'background-color: #f0ad4e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;';
                deleteCell.appendChild(deleteButton);
            });

            document.getElementById('total-expense').textContent = `${total.toLocaleString('ja-JP')} JPY`;
        }

        // --- Report Generation ---
        function generateReport() {
            const reportBody = document.getElementById('report-summary');
            const settlementList = document.getElementById('settlement-advice');
            reportBody.innerHTML = '';
            settlementList.innerHTML = '';

            if (participants.length === 0 || expenses.length === 0) {
                 settlementList.innerHTML = '<li><em>è«‹å…ˆè¨­å®šåƒèˆ‡è€…ä¸¦æ–°å¢è²»ç”¨é …ç›®...</em></li>';
                 document.getElementById('per-person-share').textContent = '0 JPY';
                 return;
            }

            const totalExpense = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const perPersonShare = totalExpense / participants.length;
            document.getElementById('per-person-share').textContent = `${perPersonShare.toFixed(2).toLocaleString('ja-JP')} JPY`;

            const participantData = {};
            participants.forEach(p => {
                participantData[p] = { totalPaid: 0, balance: 0 };
            });

            // 1. Calculate Total Paid by each person
            expenses.forEach(exp => {
                if (participantData[exp.payer]) {
                    participantData[exp.payer].totalPaid += exp.amount;
                }
            });

            // 2. Calculate Balance (Paid - Share)
            participants.forEach(p => {
                const paid = participantData[p].totalPaid;
                const balance = paid - perPersonShare;
                participantData[p].balance = balance;

                const row = reportBody.insertRow();
                row.insertCell().textContent = p;
                row.insertCell().textContent = paid.toLocaleString('ja-JP');
                row.insertCell().textContent = perPersonShare.toFixed(2).toLocaleString('ja-JP');
                
                const balanceCell = row.insertCell();
                balanceCell.textContent = balance.toFixed(2).toLocaleString('ja-JP');
                
                if (balance > 0) {
                    balanceCell.classList.add('positive'); // Is owed money
                    balanceCell.textContent = `+${balanceCell.textContent}`;
                } else if (balance < 0) {
                    balanceCell.classList.add('negative'); // Owes money
                } else {
                     balanceCell.textContent = '0.00';
                }
            });

            // 3. Generate Settlement Advice
            const balances = Object.entries(participantData).map(([name, data]) => ({ name, balance: data.balance }));
            const givers = balances.filter(b => b.balance > 0).sort((a, b) => b.balance - a.balance); // Is owed (Paid more)
            const takers = balances.filter(b => b.balance < 0).sort((a, b) => a.balance - b.balance); // Owes (Paid less)

            settlementList.innerHTML = ''; // Clear previous advice
            let totalSettled = 0;

            while (givers.length > 0 && takers.length > 0) {
                const giver = givers[0];
                const taker = takers[0];
                
                // Note: Use absolute value for what the taker owes
                const amountToSettle = Math.min(giver.balance, Math.abs(taker.balance)); 
                
                if (amountToSettle > 0.01) { // Only record significant transactions
                    totalSettled += amountToSettle;
                    const listItem = document.createElement('li');
                    listItem.textContent = `ğŸ‘‰ ${taker.name} æ‡‰æ”¯ä»˜ ${giver.name} ${amountToSettle.toFixed(2).toLocaleString('ja-JP')} JPY`;
                    listItem.style.marginBottom = '5px';
                    settlementList.appendChild(listItem);
                }

                // Update balances
                giver.balance -= amountToSettle;
                taker.balance += amountToSettle; // Taker's balance is negative, adding settlement reduces its magnitude.

                // Remove settled parties
                if (giver.balance <= 0.01) { givers.shift(); }
                if (taker.balance >= -0.01) { takers.shift(); } // Check for near-zero negative
            }
            
             if (totalSettled === 0) {
                settlementList.innerHTML = '<li><em>æ‰€æœ‰æ¬¾é …å·²çµæ¸…æˆ–å°šç„¡è²»ç”¨ç´€éŒ„ã€‚</em></li>';
             }
        }

        // Initialize on load
        window.onload = function() {
            updateParticipants(); // Initialize participants (will show "Please set")
            renderExpenses();
            generateReport();
        }

    </script>
</body>
</html>
