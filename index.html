<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€5å¤©4å¤œã€‘æ±äº¬ä¹‹æ—… - è¡Œç¨‹èˆ‡è²»ç”¨è¿½è¹¤ (Cloud Sync)</title>
    <style>
        /* --- Itinerary & General Styles --- */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        h1 {
            color: #d9534f;
            border-bottom: 3px solid #d9534f;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        h2 {
            color: #5bc0de;
            margin-top: 25px;
            border-left: 5px solid #5bc0de;
            padding-left: 10px;
        }
        .day {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .day strong {
            display: block;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 5px;
        }
        .note {
            background-color: #d9edf7;
            border: 1px solid #bce8f1;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
            color: #31708f;
        }
        .note p { margin: 5px 0; }

        /* --- Expense Tracker Styles --- */
        #expense-tracker {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 30px;
            border-top: 5px solid #28a745;
        }
        #expense-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 100px;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 4px;
        }
        #expense-form input, #expense-form select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        #expense-form button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 4px;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        #expense-form button:hover { background-color: #218838; }
        
        /* Tables */
        .expense-table, .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            text-align: left;
        }
        .expense-table th, .expense-table td, 
        .report-table th, .report-table td {
            border: 1px solid #eee;
            padding: 12px;
        }
        .expense-table th, .report-table th {
            background-color: #f8f8f8;
            color: #333;
            font-weight: bold;
        }
        .expense-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Report Summary */
        .report-table .positive { color: #28a745; font-weight: bold; }
        .report-table .negative { color: #d9534f; font-weight: bold; }
        .report-table tr.total-row td {
            font-weight: bold;
            background-color: #e9ecef;
            border-top: 2px solid #5bc0de;
        }

        /* Mobile */
        @media (max-width: 600px) {
            #expense-form { grid-template-columns: 1fr; }
            #expense-form button { grid-column: 1; }
        }
        
        /* Sync Indicator */
        .sync-status {
            font-size: 0.8em;
            text-align: right;
            color: #888;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h1>âœˆï¸ ã€5å¤©4å¤œã€‘æ±äº¬ä¹‹æ—…è¡Œç¨‹</h1>

    <div class="day">
        <h2>Day 1: æŠµé”èˆ‡å±•æœ›</h2>
        <strong>æ©Ÿå ´ â†’ é£¯åº— Check-in â†’ æ™´ç©ºå¡”</strong>
        <ul>
            <li>ç”± ç¾½ç”°æ©Ÿå ´ï¼æˆç”°æ©Ÿå ´ æŠµé”æ±äº¬å¸‚å€</li>
            <li>é£¯åº— Check in</li>
            <li>**æ™´ç©ºå¡”**ï¼ˆè³¼ç‰©ã€æ™šé¤ã€è³å¤œæ™¯ï¼‰</li>
        </ul>
    </div>

    <div class="day">
        <h2>Day 2: å‚³çµ±èˆ‡æ½®æµ (éŠ€åº§ç·šé«˜æ•ˆéŠ)</h2>
        <strong>æ·ºè‰ â†’ ç§‹è‘‰åŸ â†’ éŠ€åº§</strong>
        <ul>
            <li>**æ·ºè‰**ï¼ˆé›·é–€ã€ä»²è¦‹ä¸–é€šå•†åº—è¡—ã€æ·ºè‰å¯ºï¼‰</li>
            <li>**ç§‹è‘‰åŸé›»å™¨è¡—**</li>
            <li>**éŠ€åº§**ï¼ˆé€›è¡—ã€ä¸‹åˆèŒ¶æˆ–ç”¨é¤ï¼‰</li>
        </ul>
    </div>

    <h2>è¡Œç¨‹é‡é»æé†’ (Memo)</h2>
    <div class="note">
        <p>ãƒ»5å¤©ç©æ±äº¬æœƒè¼ƒç‚ºç·Šæ¹Šï¼Œéƒ¨åˆ†æ™¯é»å¯æ¡é‡é»å¼éŠè¦½ã€‚</p>
        <p>ãƒ»æ­¤é é¢å·²é€£æ¥é›²ç«¯è³‡æ–™åº«ï¼Œæ‰€æœ‰è£ç½®åŒæ­¥æ›´æ–°ã€‚</p>
    </div>

    <div id="expense-tracker">
        <div class="sync-status">â˜ï¸ é›²ç«¯åŒæ­¥ä¸­ (Cloud Sync Active)</div>
        <h2>ğŸ’° å…±åŒè²»ç”¨è¿½è¹¤</h2>

        <div>
            <label for="participants-input">**è¨­å®šåƒèˆ‡è€… (æ‰€æœ‰è£ç½®å°‡åŒæ­¥æ­¤è¨­å®š):**</label>
            <input type="text" id="participants-input" placeholder="å°æ˜, å°è¯, å°ç¾" style="width: 100%; margin: 5px 0 15px 0; padding: 10px;">
            <button onclick="window.updateParticipants()">âœ… æ›´æ–°é›²ç«¯åƒèˆ‡è€…åå–®</button>
            <p id="participant-status" style="margin-top: 10px; font-weight: bold; color: #5cb85c;">æ­£åœ¨è®€å–è³‡æ–™...</p>
        </div>
        <hr style="margin: 20px 0;">

        <h3>æ–°å¢è²»ç”¨é …ç›®</h3>
        <div id="expense-form">
            <input type="text" id="expense-item" placeholder="è²»ç”¨é …ç›® (e.g. æ™´ç©ºå¡”é–€ç¥¨)" required>
            <input type="number" id="expense-amount" placeholder="é‡‘é¡ (JPY)" min="1" required>
            <select id="expense-payer">
            </select>
            <button onclick="window.addExpense()">æ–°å¢</button>
        </div>

        <h3>æ‰€æœ‰è²»ç”¨åˆ—è¡¨</h3>
        <table class="expense-table">
            <thead>
                <tr>
                    <th>é …ç›®</th>
                    <th>é‡‘é¡ (JPY)</th>
                    <th>æ”¯ä»˜äºº</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="expense-list">
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="1">ç¸½å…±åŒèŠ±è²»</td>
                    <td id="total-expense" colspan="3">0 JPY</td>
                </tr>
            </tfoot>
        </table>

        <h2 style="margin-top: 30px;">ğŸ“Š è²»ç”¨çµç®—å ±å‘Š</h2>
        <p><strong>äººå‡æ‡‰ä»˜é‡‘é¡ (Per Person Share):</strong> <span id="per-person-share">0 JPY</span></p>
        <table class="report-table">
            <thead>
                <tr>
                    <th>åƒèˆ‡è€…</th>
                    <th>ç¸½æ”¯å‡º</th>
                    <th>æ‡‰ä»˜ä»½é¡</th>
                    <th>é¤˜é¡ (Owes / Is Owed)</th>
                </tr>
            </thead>
            <tbody id="report-summary">
            </tbody>
        </table>

        <h3 style="margin-top: 30px;">ğŸ’¸ çµç®—å»ºè­° (Who Owes Whom)</h3>
        <ul id="settlement-advice" style="list-style-type: none; padding-left: 0;">
             <li><em>è®€å–ä¸­...</em></li>
        </ul>
    </div>

    <div class="scroll-spacer" style="height: 100px;"></div>

  <script type="module">
        // 1. Import Firebase Functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            deleteDoc,
            doc,
            setDoc,
            getDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- âš ï¸ PASTE YOUR FIREBASE CONFIG HERE âš ï¸ ---
        const firebaseConfig = {
  apiKey: "AIzaSyAjYFnlRMwv6xkzPabHceDrK0dZkSFzDTw",
  authDomain: "lei-test2.firebaseapp.com",
  projectId: "lei-test2",
  storageBucket: "lei-test2.firebasestorage.app",
  messagingSenderId: "765250762794",
  appId: "1:765250762794:web:adfaf00ac6586ee91deb53",
  measurementId: "G-F3RX6MS2GD"
        };
        // ----------------------------------------------

        // 2. Initialize Firebase
        // Error handling for initialization
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch (e) {
            document.getElementById('participant-status').textContent = `âŒ Config Error: Check console`;
            console.error("Firebase Init Error:", e);
        }

        // Global Variables
        let expenses = [];
        let participants = [];

        // --- A. Sync Participants Logic ---
        
        const settingsRef = doc(db, "settings", "general");
        const statusText = document.getElementById('participant-status');
        
        // Listener with Error Handling
        onSnapshot(settingsRef, 
            (docSnap) => {
                // Success Callback
                if (docSnap.exists()) {
                    participants = docSnap.data().names || [];
                    document.getElementById('participants-input').value = participants.join(', ');
                    updateUIState();
                } else {
                    // Document doesn't exist yet (New Database)
                    console.log("Settings document not found. Ready to create.");
                    participants = [];
                    updateUIState();
                }
            },
            (error) => {
                // âŒ ERROR Callback (This fixes the "Stuck Loading" issue)
                console.error("Firestore Read Error:", error);
                
                if (error.code === 'permission-denied') {
                    statusText.textContent = "âŒ æ¬Šé™éŒ¯èª¤: è«‹æª¢æŸ¥ Firebase Rules";
                    statusText.style.color = "red";
                } else {
                    statusText.textContent = `âŒ é€£ç·šéŒ¯èª¤: ${error.code}`;
                    statusText.style.color = "red";
                }
            }
        );

        // Function to Write Participants to Cloud
        window.updateParticipants = async function() {
            const input = document.getElementById('participants-input').value.trim();
            statusText.textContent = "â³ æ­£åœ¨å„²å­˜...";
            
            if (input) {
                const names = input.split(/[,;]/).map(p => p.trim()).filter(p => p.length > 0);
                try {
                    // We use setDoc with {merge: true} so we don't overwrite other settings if added later
                    await setDoc(settingsRef, { names: names }, { merge: true });
                    alert("åƒèˆ‡è€…åå–®å·²åŒæ­¥è‡³é›²ç«¯ï¼");
                } catch (e) {
                    console.error("Error saving participants: ", e);
                    alert(`å„²å­˜å¤±æ•—: ${e.message}`);
                    statusText.textContent = "âŒ å„²å­˜å¤±æ•—";
                }
            } else {
                alert("è«‹è¼¸å…¥åƒèˆ‡è€…åç¨±");
                updateUIState(); // Reset text
            }
        };

        // --- B. Sync Expenses Logic ---

        const q = query(collection(db, "expenses"), orderBy("timestamp", "asc"));
        
        onSnapshot(q, (snapshot) => {
            expenses = [];
            snapshot.forEach((doc) => {
                expenses.push({ id: doc.id, ...doc.data() });
            });
            renderExpenses();
            generateReport();
        }, (error) => {
             console.error("Expenses Sync Error:", error);
        });

        // Function to Add Expense
        window.addExpense = async function() {
            const item = document.getElementById('expense-item').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const payer = document.getElementById('expense-payer').value;

            if (!item || isNaN(amount) || amount <= 0 || !payer) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦ç¢ºä¿é‡‘é¡æœ‰æ•ˆï¼');
                return;
            }

            try {
                const btn = document.querySelector('#expense-form button');
                const oldText = btn.textContent;
                btn.textContent = "å‚³é€ä¸­...";
                btn.disabled = true;

                await addDoc(collection(db, "expenses"), {
                    item: item,
                    amount: amount,
                    payer: payer,
                    timestamp: serverTimestamp()
                });
                
                // Clear form
                document.getElementById('expense-item').value = '';
                document.getElementById('expense-amount').value = '';
                
                btn.textContent = oldText;
                btn.disabled = false;
            } catch (e) {
                console.error("Error adding expense: ", e);
                alert("æ–°å¢å¤±æ•—: " + e.message);
                document.querySelector('#expense-form button').disabled = false;
            }
        };

        // Function to Delete Expense
        window.deleteExpense = async function(docId) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ`)) {
                try {
                    await deleteDoc(doc(db, "expenses", docId));
                } catch (e) {
                    console.error("Error deleting: ", e);
                    alert("åˆªé™¤å¤±æ•—");
                }
            }
        };

        // --- C. Rendering & Logic ---

        function updateUIState() {
            updatePayerDropdown();
            if(participants.length > 0) {
                statusText.textContent = `âœ… åƒèˆ‡è€… (é›²ç«¯å·²åŒæ­¥): ${participants.join(', ')}`;
                statusText.style.color = '#5cb85c';
            } else {
                statusText.textContent = `âš ï¸ è«‹è¨­å®šåƒèˆ‡è€… (è³‡æ–™åº«ç‚ºç©º)`;
                statusText.style.color = '#d9534f';
            }
            generateReport();
        }

        function updatePayerDropdown() {
            const dropdown = document.getElementById('expense-payer');
            const currentVal = dropdown.value; 
            dropdown.innerHTML = '';
            
            if (participants.length === 0) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'ç­‰å¾…åƒèˆ‡è€…è¨­å®š...';
                dropdown.appendChild(defaultOption);
                dropdown.disabled = true;
                return;
            }
            
            dropdown.disabled = false;
            participants.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                dropdown.appendChild(option);
            });
            
            if (participants.includes(currentVal)) {
                dropdown.value = currentVal;
            }
        }

        function renderExpenses() {
            const listBody = document.getElementById('expense-list');
            listBody.innerHTML = '';
            let total = 0;

            expenses.forEach((exp) => {
                total += exp.amount;
                const row = listBody.insertRow();
                row.insertCell().textContent = exp.item;
                row.insertCell().textContent = exp.amount.toLocaleString('ja-JP');
                row.insertCell().textContent = exp.payer;
                
                const deleteCell = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'åˆªé™¤';
                deleteButton.onclick = () => window.deleteExpense(exp.id);
                deleteButton.style.cssText = 'background-color: #f0ad4e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;';
                deleteCell.appendChild(deleteButton);
            });

            document.getElementById('total-expense').textContent = `${total.toLocaleString('ja-JP')} JPY`;
        }

        function generateReport() {
            const reportBody = document.getElementById('report-summary');
            const settlementList = document.getElementById('settlement-advice');
            reportBody.innerHTML = '';
            settlementList.innerHTML = '';

            if (participants.length === 0 || expenses.length === 0) {
                 settlementList.innerHTML = '<li><em>ç­‰å¾…è³‡æ–™...</em></li>';
                 document.getElementById('per-person-share').textContent = '0 JPY';
                 return;
            }

            const totalExpense = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const perPersonShare = totalExpense / participants.length;
            document.getElementById('per-person-share').textContent = `${perPersonShare.toFixed(2).toLocaleString('ja-JP')} JPY`;

            const participantData = {};
            participants.forEach(p => {
                participantData[p] = { totalPaid: 0, balance: 0 };
            });

            expenses.forEach(exp => {
                if (participantData[exp.payer]) {
                    participantData[exp.payer].totalPaid += exp.amount;
                }
            });

            participants.forEach(p => {
                const paid = participantData[p].totalPaid;
                const balance = paid - perPersonShare;
                participantData[p].balance = balance;

                const row = reportBody.insertRow();
                row.insertCell().textContent = p;
                row.insertCell().textContent = paid.toLocaleString('ja-JP');
                row.insertCell().textContent = perPersonShare.toFixed(2).toLocaleString('ja-JP');
                
                const balanceCell = row.insertCell();
                balanceCell.textContent = balance.toFixed(2).toLocaleString('ja-JP');
                
                if (balance > 0) {
                    balanceCell.classList.add('positive');
                    balanceCell.textContent = `+${balanceCell.textContent}`;
                } else if (balance < 0) {
                    balanceCell.classList.add('negative');
                } else {
                     balanceCell.textContent = '0.00';
                }
            });

            const balances = Object.entries(participantData).map(([name, data]) => ({ name, balance: data.balance }));
            const givers = balances.filter(b => b.balance > 0).sort((a, b) => b.balance - a.balance);
            const takers = balances.filter(b => b.balance < 0).sort((a, b) => a.balance - b.balance);

            let totalSettled = 0;

            while (givers.length > 0 && takers.length > 0) {
                const giver = givers[0];
                const taker = takers[0];
                const amountToSettle = Math.min(giver.balance, Math.abs(taker.balance)); 
                
                if (amountToSettle > 1) { 
                    totalSettled += amountToSettle;
                    const listItem = document.createElement('li');
                    listItem.textContent = `ğŸ‘‰ ${taker.name} æ‡‰æ”¯ä»˜ ${giver.name} ${amountToSettle.toFixed(0).toLocaleString('ja-JP')} JPY`;
                    listItem.style.marginBottom = '5px';
                    settlementList.appendChild(listItem);
                }
                giver.balance -= amountToSettle;
                taker.balance += amountToSettle;

                if (giver.balance <= 0.1) { givers.shift(); }
                if (taker.balance >= -0.1) { takers.shift(); } 
            }
            
             if (totalSettled === 0) {
                settlementList.innerHTML = '<li><em>ç„¡éœ€çµç®—ã€‚</em></li>';
             }
        }
    </script>
</body>
</html>
